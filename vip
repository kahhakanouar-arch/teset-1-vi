local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local activeESP = {}
local espEnabled = true
local keybind = Enum.KeyCode.Y
local updateRate = 0.4  -- Pas trop rapide

local function getEquippedTool(player)
    if not player.Character then return nil end
    for _, child in ipairs(player.Character:GetChildren()) do
        if child:IsA("Tool") then
            return child
        end
    end
    return nil
end

local function getToolName(tool)
    if not tool then return "None" end
    -- On essaie de trouver un nom "propre" si possible
    local display = tool.Name
    if tool:FindFirstChild("DisplayName") then
        display = tool.DisplayName.Value
    elseif tool:GetAttribute("DisplayName") then
        display = tool:GetAttribute("DisplayName")
    end
    return display
end

local function createToolESP(player)
    if activeESP[player.Name] then return end
    
    local char = player.Character
    if not char or not char:FindFirstChild("Head") then return end
    
    local head = char.Head
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ToolESP"
    billboard.Parent = head
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 180, 0, 90)  -- compact
    billboard.StudsOffset = Vector3.new(0, 3.2, 0)
    billboard.AlwaysOnTop = true
    billboard.LightInfluence = 0
    billboard.Enabled = espEnabled
    
    local frame = Instance.new("Frame", billboard)
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = Color3.fromRGB(10, 10, 20)
    frame.BackgroundTransparency = 0.45
    frame.BorderSizePixel = 0
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 6)
    
    local stroke = Instance.new("UIStroke", frame)
    stroke.Color = Color3.fromRGB(90, 70, 220)
    stroke.Thickness = 1.2
    stroke.Transparency = 0.3
    
    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, -10, 0, 18)
    title.Position = UDim2.new(0, 5, 0, 4)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold
    title.TextSize = 13
    title.TextColor3 = Color3.fromRGB(220, 220, 255)
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Text = player.DisplayName
    
    local toolsText = Instance.new("TextLabel", frame)
    toolsText.Name = "ToolsLabel"
    toolsText.Size = UDim2.new(1, -10, 1, -26)
    toolsText.Position = UDim2.new(0, 5, 0, 24)
    toolsText.BackgroundTransparency = 1
    toolsText.Font = Enum.Font.Gotham
    toolsText.TextSize = 11
    toolsText.TextColor3 = Color3.fromRGB(180, 180, 220)
    toolsText.TextXAlignment = Enum.TextXAlignment.Left
    toolsText.TextYAlignment = Enum.TextYAlignment.Top
    toolsText.TextWrapped = true
    toolsText.Text = "Loading..."
    
    local lastUpdate = 0
    
    local function updateDisplay()
        local now = tick()
        if now - lastUpdate < updateRate then return end
        lastUpdate = now
        
        local equipped = getEquippedTool(player)
        local tools = {}
        
        if equipped then
            table.insert(tools, "EQP: " .. getToolName(equipped))
        end
        
        if player.Backpack then
            for _, tool in ipairs(player.Backpack:GetChildren()) do
                if tool:IsA("Tool") then
                    table.insert(tools, getToolName(tool))
                end
            end
        end
        
        local text = ""
        if #tools == 0 then
            text = "No tools"
        else
            text = table.concat(tools, "\n")
        end
        
        toolsText.Text = text
        
        -- Distance
        local hrp = char:FindFirstChild("HumanoidRootPart")
        local lhrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if hrp and lhrp then
            local dist = (hrp.Position - lhrp.Position).Magnitude
            title.Text = player.DisplayName .. "   [" .. math.floor(dist) .. " studs]"
        else
            title.Text = player.DisplayName
        end
    end
    
    updateDisplay()
    
    local conn
    conn = RunService.Heartbeat:Connect(function()
        if not player.Parent or not player.Character or not player.Character.Parent then
            conn:Disconnect()
            if activeESP[player.Name] then
                activeESP[player.Name].billboard:Destroy()
                activeESP[player.Name] = nil
            end
            return
        end
        updateDisplay()
    end)
    
    activeESP[player.Name] = {billboard = billboard, connection = conn}
end

local function toggleESP()
    espEnabled = not espEnabled
    for _, data in pairs(activeESP) do
        data.billboard.Enabled = espEnabled
    end
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == keybind then
        toggleESP()
    end
end)

-- Initialisation
for _, plr in ipairs(Players:GetPlayers()) do
    if plr ~= LocalPlayer then
        task.spawn(function()
            if plr.Character then
                createToolESP(plr)
            end
            plr.CharacterAdded:Connect(function()
                task.wait(0.6)
                createToolESP(plr)
            end)
        end)
    end
end

Players.PlayerAdded:Connect(function(plr)
    if plr == LocalPlayer then return end
    plr.CharacterAdded:Connect(function()
        task.wait(0.6)
        if espEnabled then
            createToolESP(plr)
        end
    end)
end)

Players.PlayerRemoving:Connect(function(plr)
    if activeESP[plr.Name] then
        activeESP[plr.Name].connection:Disconnect()
        activeESP[plr.Name].billboard:Destroy()
        activeESP[plr.Name] = nil
    end
end)

print("Hermanos-style Tool ESP activÃ© ! Touche Y pour toggle.")
